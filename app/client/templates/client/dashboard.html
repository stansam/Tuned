{% extends "client/base.html" %}
{% block title %}Dashboard {% endblock %}
{% block styles %}
{{ super()}}
{% assets "client_client_dashboard_css" %}
    <link rel="stylesheet" href="{{ ASSET_URL }}">
{% endassets %}
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- <link rel="stylesheet" href="{{ url_for('client.static', filename='client/js/profile/refresh.js') }}">
<link rel="stylesheet" href="{{ url_for('client.static', filename='client/js/profile/edit-profile.js') }}"> -->
<script>
    function refreshDashboard() {
        const refreshIcon = document.querySelector('.sync-button i');
        refreshIcon.style.animation = 'spin 1s linear infinite';
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    // Global variables
    let isLoading = false;

    // Modal functions
    function openProfileModal() {
        const modal = document.getElementById('profileModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        loadUserData();
    }

    function closeProfileModal() {
        const modal = document.getElementById('profileModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        clearForm();
    }

    // Load current user data
    async function loadUserData() {
        try {
            const response = await fetch(`${API_BASE_URL}/profile`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const userData = await response.json();
                populateForm(userData);
            } else {
                console.error('Failed to load user data');
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    // Populate form with user data
    function populateForm(userData) {
        document.getElementById('firstName').value = userData.first_name || '';
        document.getElementById('lastName').value = userData.last_name || '';
        document.getElementById('username').value = userData.username || '';
        document.getElementById('email').value = userData.email || '';
        document.getElementById('gender').value = userData.gender || '';
    }

    // Clear form and errors
    function clearForm() {
        document.getElementById('profileForm').reset();
        clearErrors();
        hideSuccessMessage();
    }

    // Clear all error messages
    function clearErrors() {
        const errorMessages = document.querySelectorAll('.error-message');
        const inputs = document.querySelectorAll('input, select');
        
        errorMessages.forEach(error => {
            error.classList.remove('show');
            error.textContent = '';
        });
        
        inputs.forEach(input => {
            input.classList.remove('error');
        });
    }

    // Show error for specific field
    function showError(fieldName, message) {
        const errorElement = document.getElementById(fieldName + 'Error');
        const inputElement = document.getElementById(fieldName);
        
        if (errorElement && inputElement) {
            errorElement.textContent = message;
            errorElement.classList.add('show');
            inputElement.classList.add('error');
        }
    }

    // Show success message
    function showSuccessMessage() {
        const successMessage = document.getElementById('successMessage');
        successMessage.classList.add('show');
        setTimeout(hideSuccessMessage, 3000);
    }

    // Hide success message
    function hideSuccessMessage() {
        const successMessage = document.getElementById('successMessage');
        successMessage.classList.remove('show');
    }

    // Set loading state
    function setLoading(loading) {
        isLoading = loading;
        const saveBtn = document.getElementById('saveBtn');
        
        if (loading) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner"></span>Saving...';
        } else {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save Changes';
        }
    }

    // Form submission
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (isLoading) return;
        
        clearErrors();
        setLoading(true);
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`${API_BASE_URL}/profile`, {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccessMessage();
                setTimeout(() => {
                    closeProfileModal();
                }, 1500);
            } else {
                // Handle validation errors
                if (result.errors) {
                    Object.keys(result.errors).forEach(field => {
                        showError(field, result.errors[field]);
                    });
                } else {
                    alert(result.message || 'An error occurred while updating your profile.');
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please try again.');
        } finally {
            setLoading(false);
        }
    });

    // Close modal when clicking outside
    document.getElementById('profileModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeProfileModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('profileModal').classList.contains('active')) {
            closeProfileModal();
        }
    });

    // Real-time validation
    document.getElementById('email').addEventListener('blur', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            showError('email', 'Please enter a valid email address.');
        }
    });

    document.getElementById('username').addEventListener('blur', function() {
        const username = this.value;
        
        if (username && username.length < 3) {
            showError('username', 'Username must be at least 3 characters long.');
        }
    });
</script>
<script src="{{ url_for('client.static', filename='client/js/profile/upload-profile-pic.js') }}"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Profile Section -->
    <div class="profile-section">
        <div class="profile-header">
            <div class="profile-title-section">
                <h1 class="profile-title">My Profile</h1>
                <p class="profile-welcome">Welcome back, {{ current_user.first_name }} {{ current_user.last_name }}!</p>
                <p class="profile-subtitle">Here's what's happening with your account today</p>
            </div>
            <div class="profile-actions">
                <button type="button" class="edit-button" onclick="openProfileModal()">Edit Profile</button>
                <button type="button" class="sync-button" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <div class="date-info">
            <div class="date-bullet"></div>
            <span>{{ current_time.strftime('%B %d, %Y') }}</span>
        </div>

        <div class="profile-content">
            <div class="dashboard-profile-avatar">
                <img src="{% if current_user.profile_pic and current_user.profile_pic != 'default.png' %}{{ current_user.get_profile_pic_url() }} {% else %} {{url_for('client.static', filename='client/assets/profile_pics/default.png')}} {% endif %} " 
                         alt="Profile Picture" 
                         class="dash-profile-pic">
                {#{{ (current_user.first_name[0] if current_user.first_name else 'U') + (current_user.last_name[0] if current_user.last_name else '') }}#}
            </div>

            <div class="profile-details">
                <div class="profile-info">
                    <div class="profile-info-label">Username:</div>
                    <div class="profile-info-value">{{ current_user.username or 'YatchChie' }}</div>
                </div>
                
                <div class="profile-info">
                    <div class="profile-info-label">Account Type:</div>
                    <div class="profile-info-value">{{ 'TunedOps' if current_user.is_admin else 'Patron' }}</div>
                </div>
                
                <div class="profile-info">
                    <div class="profile-info-label">Member Since:</div>
                    <div class="profile-info-value">{{ current_user.created_at.strftime('%b %Y') if current_user.created_at else 'June 2025' }}</div>
                </div>

                <div class="profile-badges">
                    <span class="badge badge-active">Active</span>
                </div>
            </div>

            <div class="stats-section">
                <div class="stat-item">
                    <div class="stat-number">{{ total_orders }}</div>
                    <div class="stat-label">
                        Orders
                        <div class="info-icon" title="Total Number of orders">i</div>
                        <!-- <div class="info-text"></div> -->
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-number">${{ "%.0f"|format(total_spent) }}</div>
                    <div class="stat-label">
                        Spent
                        <div class="info-icon" title="Total Amount Spent">i</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-number">{{ reward_points }}</div>
                    <div class="stat-label">
                        Rewards
                        <div class="info-icon" title="Total Reward Points earned">i</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order History Section -->
    <div class="order-history">
        <h2 class="order-history-title">Order History</h2>
        
        <table class="order-table">
            <thead>
                <tr>
                    <th>Order</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Cost</th>
                    <th>Review</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td>{{ order.order_number or order.id }}</td>
                    <td>
                        {% set time_diff = (current_time - order.created_at).total_seconds() %}
                        {% if time_diff < 3600 %}
                            {{ "%.0f"|format(time_diff / 60) }} minutes ago
                        {% elif time_diff < 86400 %}
                            {{ "%.0f"|format(time_diff / 3600) }} hours ago
                        {% else %}
                            {{ order.created_at.strftime('%b %d, %Y, %I:%M %p') }}
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ order.status }}">
                            {{ order.status.title() }}
                        </span>
                    </td>
                    <td class="price">${{ "%.0f"|format(order.total_price or 0) }}</td>
                    <td>
                        {% if order.status == 'completed' %}
                        <div class="rating">
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                        </div>
                        {% else %}
                        <div class="rating">
                            <span class="star star-empty">☆</span>
                            <span class="star star-empty">☆</span>
                            <span class="star star-empty">☆</span>
                            <span class="star star-empty">☆</span>
                            <span class="star star-empty">☆</span>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                        No orders found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% include 'client/profile/edit-profile.html' %}
{% endblock %}
